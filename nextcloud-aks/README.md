# Resources for Running Nextcloud on an Azure Kubernetes Service (AKS)
This folder contains docker images, configurations, and scripts to assist in 
getting Nextcloud to run  on an Azure Kubernetes Service.

This approach offers significantly more flexibility for storage than trying to
run Nextcloud on Azure Container Instances.

## Deploying Nextcloud to AKS
### Dependencies
You will need:
- An AKS cluster with at least one node (F2s v2 instances are recommended).
- An Azure Container Registry (ACR) setup.
- CLI interfaces for each of the following installed locally:
    - Azure (`az`)
    - MySQL (`mysql`)
    - Docker (`docker`)
- The Azure CLI must be 
  [signed-in to your Azure account](https://docs.microsoft.com/en-us/cli/azure/authenticate-azure-cli).
- For best results, you should have 
  [the "Global administrator" role](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles) 
  within your Azure AD tenant.
- Credentials and settings should be specified in the `config.env` file (see 
  next section).

### Choosing the Pod Type
The configurations in this repository support two different Kubernetes pod 
deployment models:
 - An Apache-based deployment model (`apache`), in which Nextcloud is hosted on 
   Apache, with PHP served up via `mod_php` and Apache handling static files 
   directly. Everything necessary to run the Nextcloud is handled by pods 
   containing a single container called `backend-nextcloud-apache`.

 - A PHP-FPM-based deployment model (`fpm-nginx`), in which Nextcloud is hosted 
   on a combination of technologies, with PHP served up via PHP-FPM proxied 
   through Nginx, and Nginx handling static file hosting. This deployment 
   consists of pods with two containers -- `backend-nextcloud-fpm` and 
   `middle-nextcloud-nginx`.

Set this via the `POD_TYPE` setting in `config.env`.

### Providing Settings to the Script
All of the settings needed by scripts need to be provided in `config.env`.

Copy `config.example.env` to `config.env` and then customize it for your needs.

### Granting AKS Access to ACR
In order to use the Docker images generated by the Dockerfiles in this repo, you
will need to publish them to ACR, and you will need to give AKS a means to 
access ACR.

The preferred approach for this is by generating a _service principal_ 
(basically, a user account for AKS to log-in to ACR) and then granting that
service principal only the necessary permissions to access ACR.

The `./setup_aks_acr_service_principal.sh` script can set this up for you
automatically, based on settings in `config.env`. You only need to run this 
script once, even if you have removed Nextcloud from your Azure deployment with 
`./delete_nextcloud.sh`.

### Running the Deployment
Run `./deploy_nextcloud.sh` to create storage accounts and deploy Nextcloud to 
AKS.

Alternatively, open the `./deploy_nextcloud.sh` script in a text editor to 
review each of the other scripts that top-level script invokes to do its work, 
and then invoke them piecewise to deploy only the portions you'd like to deploy.
Please note that scripts are listed in dependency order; Nextcloud requires
storage accounts to be in place and registered with Kubernetes as persistent
volumes in order for deployment of Nextcloud pods to proceed.

## Removing Nextcloud from AKS
Run `./delete_nextcloud.sh` to fully remove Nextcloud and its storage accounts
from your AKS and Azure instance. **Beware that this will remove all files you 
currently have stored on Nextcloud.**

Alternatively, open the `./delete_nextcloud.sh` script in a text editor to 
review each of the other scripts that top-level script invokes to do its work, 
and then invoke only the scripts that remove the portions you'd like to remove.

## Admin Utility Scripts
A few scripts have been provided to make administration of deployments slightly
easier.

### Publishing Container Images to ACR
The `./publish_container_images.sh` script can be used to build and publish all 
of the images under `docker` to your ACR instance.

### Connecting to the AKS Kubernetes Dashboard
Run `./launch_aks_dashboard.sh` to setup a tunnel on your local machine at port
`8090`. This script wraps the `az aks browse` command, providing some additional
enhancements like automatic restoration of the tunnel if it dies.

### Connecting to the MySQL CLI
Run `./launch_db_shell.sh` to launch the MySQL CLI, connected via the same 
credentials that Nextcloud uses to connect.
